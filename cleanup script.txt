#!/bin/bash

# Path to the container cleanup script on the host
CONTAINER_CLEANUP_SCRIPT=/cleanup_scripts/container_cleanup.sh  

# Log file to store the output
LOG_FILE=/cleanup_scripts/host_cleanup.log  

# Ensure the log directory exists
LOG_DIR=$(dirname "$LOG_FILE")
mkdir -p "$LOG_DIR"

# Ensure the log file exists and has appropriate permissions
touch "$LOG_FILE"
chmod 664 "$LOG_FILE"

# Verify that the container cleanup script exists
if [[ ! -f "$CONTAINER_CLEANUP_SCRIPT" ]]; then
    echo "Error: Cleanup script $CONTAINER_CLEANUP_SCRIPT not found." >> "$LOG_FILE"
    exit 1
fi

# Get a list of all running container IDs
CONTAINERS=$(docker ps -q)

# Iterate through each container
for CONTAINER_ID in $CONTAINERS; do
    # Check if the container is in a running state
    CONTAINER_STATE=$(docker inspect -f '{{.State.Status}}' $CONTAINER_ID)

    if [ "$CONTAINER_STATE" != "running" ]; then
        echo "Skipping container $CONTAINER_ID: current state is $CONTAINER_STATE" >> "$LOG_FILE"
        continue
    fi

    echo "Cleaning up logs in container $CONTAINER_ID" >> "$LOG_FILE"
    
    # Copy the cleanup script to the container
    if docker cp "$CONTAINER_CLEANUP_SCRIPT" "$CONTAINER_ID:/tmp/container_cleanup.sh"; then
        # Run the cleanup script inside the container and log the output
        if docker exec "$CONTAINER_ID" bash /tmp/container_cleanup.sh >> "$LOG_FILE" 2>&1; then
            echo "Cleanup successful in container $CONTAINER_ID" >> "$LOG_FILE"
        else
            echo "Error running cleanup script in container $CONTAINER_ID" >> "$LOG_FILE"
        fi

        # Optionally, remove the cleanup script from the container
        docker exec "$CONTAINER_ID" rm /tmp/container_cleanup.sh || echo "No cleanup script to remove in container $CONTAINER_ID" >> "$LOG_FILE"
    else
        echo "Error copying cleanup script to container $CONTAINER_ID" >> "$LOG_FILE"
    fi
done

echo "Cleanup completed at $(date)" >> "$LOG_FILE"

========================
0 0 * * 0 /cleanup_scripts/host_cleanup.sh

crontab -e
crontab -l 

/cleanup_scripts
container_cleanup.sh
host_cleanup.sh

====================
#!/bin/bash

# Delete log files older than 1 day in specified directories inside the container

find /opt/MetricStream/SYSTEMi/KMS/KMP/log -type f -mtime +1 -delete
find /opt/MetricStream/SYSTEMi/Systemi/log -type f -mtime +1 -delete
find /opt/MetricStream/SYSTEMi/BAPI/log -type f -mtime +1 -delete
find /opt/MetricStream/SYSTEMi/Tomcat/logs -type f -mtime +1 -delete
find /opt/MetricStream/SYSTEMi/kafka/logs -type f -mtime +1 -delete
find /opt/MetricStream/SYSTEMi/Apache/logs -type f -mtime +1 -delete

# Delete all unwanted files older than 15 day in specified directories inside the container

find / -type f -name "*.zip" -mtime +14 -delete
find / -type f -name "*.msar" -mtime +14 -delete
find / -type f -name "*.log" -mtime +14 -delete
find /tmp/* -daystart -mtime +7 -delete
